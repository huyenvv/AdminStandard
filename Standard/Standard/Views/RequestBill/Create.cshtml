@model Checkout
@using WebLib.DAL
@{
    var currentUser = fwUserDAL.GetCurrentUser();
    var listCheckout = WebLib.SessionUtilities.Exist(Constant.SESSION_CheckoutDetails) ? (List<CheckoutDetails>)WebLib.SessionUtilities.Get(Constant.SESSION_CheckoutDetails) : null;
    ViewBag.Title = "ĐỀ NGHỊ THANH TOÁN/ PAYMENT VOUCHER";
    var listType = new[] { "", "", "" };
    if (Model.PaymentMethod.HasValue)
    {
        listType[Model.PaymentMethod.Value] = "checked='checked'";
    }
    var listDept = (List<Dept>)ViewBag.listDept;
    var listDetail = Model.CheckoutDetails;
    var ticketID = int.Parse(Request.QueryString["ticketID"]);
    var db = DB.Entities;
    var tick = db.Ticket.FirstOrDefault(m => m.ID == ticketID);
    var ticketTitle = tick.Created.ToString("dd/MM/yyyy") + " - " + tick.TicketDetails.FirstOrDefault().Title + " ...";

    var lstChkDetails = new List<CheckoutDetails>();
    foreach (var item in tick.TicketDetails)
    {
        lstChkDetails.Add(new CheckoutDetails() { Title = item.Title, ID=item.ID });
    }
}
@section  scripts{
    <script src="~/Content/lib/ma/js/input-mask.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script src="~/Content/js/checkout.js"></script>
    <script>
        var app = angular.module('myApp', []);
        app.controller('myCtrl', function ($scope) {

            $scope.vnd = [
                @for (int i = 0; i < listDetail.Count; i++)
                {
                    @(listDetail.ElementAt(i).VND + ",")
                }
            0];
            $scope.usd = [
                @for (int i = 0; i < listDetail.Count; i++)
                {
                    @(listDetail.ElementAt(i).USD + ",")
                }
            0];
            $scope.getTotalVND = function () {
                if ($scope.vnd.length > 0) {
                    var value = eval($scope.vnd.join('+').replace(/\./g, ''));
                    return format(value, '');
                }
            };
            $scope.getTotalUSD = function () {
                if ($scope.usd.length > 0) {
                    var value = eval($scope.usd.join('+').replace(/\./g, ''));
                    return format(value, '');
                }
            };
            format = function (n, currency) {
                return currency + " " + n.toFixed(0).replace(/./g, function (c, i, a) {
                    return i > 0 && c !== "." && (a.length - i) % 3 === 0 ? "." + c : c;
                });
            }


            // Tạm ứng phí ngân hàng
            $scope.tamungVND = 0;
            $scope.tamungUSD = 0;
            $scope.PhiNganHangVND = 0;
            $scope.PhiNganHangUSD = 0;

            $scope.getAllTotalVND = function () {
                if ($scope.vnd.length > 1) {
                    var subtotal = eval($scope.vnd.join('+').replace(/\./g, ''));
                    var value = subtotal + "-" + $scope.tamungVND + "+" + $scope.PhiNganHangVND;
                    var allTotal = value.replace(/\./g, '');
                    return format(allTotal, '');
                }
            };
            $scope.getAllTotalUSD = function () {
                if ($scope.usd.length > 1) {
                    var subtotal = eval($scope.usd.join('+').replace(/\./g, ''));
                    var value = subtotal + "-" + $scope.tamungUSD + "+" + $scope.PhiNganHangUSD;
                    var allTotal = value.replace(/\./g, '');
                    return format(allTotal, '');
                }
            };
        });
    </script>

}


@using (Html.BeginForm(null, null, new { returnUrl = Request.QueryString["returnUrl"] }, FormMethod.Post))
{
    @Html.AntiForgeryToken()
    @Html.Hidden("isSend", true)
    @Html.Hidden("ticketID", ticketID)
    @Html.HiddenFor(m => m.ID)

    @Html.ValidationSummary(true)
    <div class="row">
        <div class="col-md-12">
            @*<button type="submit" class="btn btn-primary" onclick="return CheckCheckout(false);">Lưu lại</button>*@
            <button type="submit" class="btn btn-primary" onclick="return CheckCheckout(true);">Gửi đề nghị</button>
            <a href="@Request.QueryString["returnUrl"]" class="btn btn-default">Hủy</a>
        </div>
    </div>
    <br />

    <div class="validationWrapper">
        <div class="row">
            <div class="col-sm-12">
                <span>Từ phiếu yêu cầu: </span><span style="font-size:1.1em; font-weight:bold; color:blue">@ticketTitle</span>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-sm-3">
                <div class="form-group fg-float">
                    <div class="fg-line">
                        <label>Ngày <i>(Dated)</i></label>
                        <input type="text" name="PaymentDate" value="@Model.Created.ToString("dd/MM/yyyy")" class=" form-control date-picker" data-toggle="dropdown" aria-expanded="false" />
                    </div>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="form-group fg-float">
                    <div class="fg-line">
                        <label>Số ghi sổ <i>(No)</i></label>
                        <input type="text" name="No" value="@Model.No" class=" form-control fg-input" />
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group fg-float">
                    <div class="fg-line">
                        <label>Người hưởng <i>(Ben)</i></label>
                        <input type="text" name="Ben" value="@Model.Ben" class=" form-control fg-input" />
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group fg-float">
                    <div class="fg-line">
                        <label>Phòng <i>(Dept)</i></label>
                        <div class="select">
                            <select class="form-control" name="DeptID">
                                @foreach (var item in listDept)
                                {
                                    <option value="@item.ID" @(item.ID == Model.DeptID ? "selected='selected'" : "")>@item.Title</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <label class="col-md-4">Hình thức thanh toán <i>(Payment method)</i> : </label>
            <div class="col-md-8">
                <label class="checkbox checkbox-inline m-r-20">
                    <input type="checkbox" class="onCheckbox" name="PaymentMethod" value="0" @listType[0] />
                    <i class="input-helper"></i>
                    Tiền mặt <br /><i>(Cash)</i>
                </label>
                <label class="checkbox checkbox-inline m-r-20">
                    <input type="checkbox" class="onCheckbox" name="PaymentMethod" value="1" @listType[1] />
                    <i class="input-helper"></i>
                    Chuyển khoản <br /><i>(Bank transfer)</i>
                </label>
                <label class="checkbox checkbox-inline m-r-20">
                    <input type="checkbox" class="onCheckbox" name="PaymentMethod" value="2" @listType[2] />
                    <i class="input-helper"></i>
                    Quyết toán tạm ứng <br /><i>(Advance clearing)</i>
                </label>
                <div id="loaiticket" class="hide has-error">
                    <small id="loaiticket" class="help-block">Bạn phải chọn một trong 3 loại trên!</small>
                </div>
            </div>
        </div>
    </div>
    <br />
    <div class="row" ng-app="myApp" ng-controller="myCtrl">
        <div class="col-md-12">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        @*<th rowspan="2" class="text-center">
                                Mã
                                <i>Dept</i>
                            </th>
                            <th colspan="2" class="text-center">
                                Chứng từ
                                <i>(Documents)</i>
                            </th>*@
                        <th rowspan="2" class="text-center">
                            Nội dung <i>(Description)</i>
                        </th>
                        <th colspan="2" class="text-center">
                            Số tiền
                        </th>
                    </tr>
                    <tr>
                        @*<th class="text-center">
                                Số <i>(No.)</i>
                            </th>
                            <th class="text-center">
                                Ngày <i>(Date)</i>
                            </th>*@
                        <th class="text-center" width="150">
                            VNĐ
                        </th>
                        <th class="text-center" width="150">
                            USD/EUR
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < lstChkDetails.Count; i++)
                    {
                        <tr>
                            <td>
                                <div class="fg-line">
                                    <textarea rows="3" class=" form-control">@lstChkDetails.ElementAt(i).Title</textarea>
                                </div>
                            </td>
                            <td>
                                <div class="fg-line">
                                    <input type="text" class=" form-control input-mask" name="details_@(lstChkDetails.ElementAt(i).ID)" ng-model="vnd[@i]" data-mask="000.000.000.000.000,00" />
                                </div>
                            </td>
                            <td>
                                <div class="fg-line">
                                    <input type="text" class=" form-control input-mask" name="details_@(lstChkDetails.ElementAt(i).ID)" ng-model="usd[@i]" data-mask="000.000.000.000.000,00" />
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td>
                            <strong>Cộng</strong> <i>(Sub-total)</i>
                        </td>
                        <td class="text-right">
                            {{getTotalVND()}}
                        </td>
                        <td class="text-right">
                            {{getTotalUSD()}}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>Tạm ứng</strong> <i>(Advance payment)</i>
                        </td>
                        <td>
                            <div class="fg-line">
                                <input type="text" class=" form-control input-mask" ng-model="tamungVND" data-mask="000.000.000.000.000,00" />
                            </div>
                        </td>
                        <td>
                            <div class="fg-line">
                                <input type="text" class=" form-control input-mask" ng-model="tamungUSD" data-mask="000.000.000.000.000,00" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>Phí ngân hàng</strong> <i>(Bank charge)</i>
                        </td>
                        <td>
                            <div class="fg-line">
                                <input type="text" class=" form-control input-mask" ng-model="PhiNganHangVND" data-mask="000.000.000.000.000,00" />
                            </div>
                        </td>
                        <td>
                            <div class="fg-line">
                                <input type="text" class=" form-control input-mask" ng-model="PhiNganHangUSD" data-mask="000.000.000.000.000,00" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>Tổng cộng</strong> <i>(Total)</i>
                        </td>
                        <td>
                            {{getAllTotalVND()}}
                        </td>
                        <td>
                            {{getAllTotalUSD()}}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <strong> Bằng chữ </strong><i>(in words): </i>
                            <div class="fg-line">
                                <input type="text" class=" form-control" name="InWords"/>
                            </div>
                        </td>
                    </tr>
                </tfoot>
            </table>
            <br />
            <div id="loaiCheckoutDetail" class="hide has-error">
                <small id="loaiCheckout" class="help-block">Bạn phải thêm Checkout detail trước.</small>
            </div>
        </div>
    </div>

}
